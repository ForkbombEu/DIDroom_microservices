<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Didroom Credential Verification</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body
    class="min-h-screen flex flex-col bg-white text-black font-mono antialiased"
  >
    <!-- Header with Didroom logo -->
    <header class="py-6 flex items-center justify-center">
      <img src="didroom-logo.svg" alt="Didroom logo" class="h-10" />
    </header>

    <!-- Debug toggle button -->
    <button
      id="debug-toggle"
      class="fixed top-5 right-5 z-50 bg-black text-white px-4 py-1.5 text-[0.7rem] uppercase tracking-widest rounded"
    >
      Debug
    </button>

    <!-- Main content -->
    <main
      class="flex-grow flex flex-col items-center px-4 text-center space-y-6"
    >
      <h1 class="text-2xl font-bold tracking-wide">Verify with Didroom</h1>
      <p class="text-base leading-relaxed max-w-md">
        Scan the QR code below with your preferred digital‚Äëwallet app to begin a
        secure credential verification in Didroom.
      </p>

      <!-- QR & Wallet button -->
      <div class="flex flex-col items-center space-y-3">
        <img
          id="qr_image"
          class="w-48 h-48"
          alt="Scan to verify your credential with Didroom"
        />
        <a
          id="open_wallet"
          href="#"
          class="bg-black text-white px-4 py-1.5 text-xs uppercase tracking-widest rounded"
          >Open in wallet</a
        >
      </div>

      <!-- Error box (hidden) -->
      <div
        id="error-box"
        class="hidden w-full max-w-md text-xs border border-red-600 text-red-600 p-3 rounded"
      ></div>

      <!-- Verification status (dots) -->
      <div
        id="verification-status"
        class="hidden text-sm flex items-center justify-center gap-1"
      >
        <span id="status-text">Starting verification</span>
        <span id="dots">...</span>
      </div>

      <!-- Claims table (success) -->
      <div
        id="claims-box"
        class="hidden w-full max-w-md text-xs border border-green-600 bg-green-50 text-green-800 p-4 rounded shadow-sm"
      >
        <h3 class="font-semibold flex items-center mb-3 text-sm">
          <span class="mr-1 text-green-600">‚úì</span> Verified Claims
        </h3>
        <table class="w-full border-collapse text-[0.8rem]">
          <tbody id="claims-table"></tbody>
        </table>
      </div>

      <noscript class="text-sm max-w-md">
        This page is plain HTML. If your wallet requires JavaScript, please
        enable it while scanning.
      </noscript>
    </main>

    <!-- Footer -->
    <footer class="py-6 border-t border-black text-xs">
      <div class="flex items-center justify-center gap-2">
        <span>¬© 2025 Didroom</span>
        <span aria-hidden="true">¬∑</span>
        <a
          href="https://github.com/forkbombeu/wallet"
          class="underline hover:no-underline"
          target="_blank"
          rel="noopener"
          >Source code</a
        >
        <span aria-hidden="true">¬∑</span>
        <span
          >made&nbsp;with&nbsp;üíì by
          <a href="https://forkbomb.eu" class="underline font-bold">Forkbomb</a>
          hackers</span
        >
      </div>
    </footer>

    <!-- Sliding debug panel (bottom) -->
    <div
      id="debug-panel"
      class="fixed inset-x-0 bottom-0 h-1/2 bg-white/95 text-black p-6 overflow-auto z-40 transform translate-y-full transition-transform duration-300 ease-in-out"
    >
      <button id="debug-close" class="absolute top-4 right-4 underline text-sm">
        Close
      </button>
      <div class="h-full flex divide-x divide-black">
        <!-- Left: DCQL textarea -->
        <div class="w-1/2 pr-5 flex flex-col space-y-2 overflow-auto">
          <h2 class="text-sm font-bold">DCQL Query</h2>
          <textarea
            id="dcql_query"
            class="flex-grow w-full border border-black p-2 text-xs leading-snug resize-none rounded font-mono"
          ></textarea>
        </div>
        <!-- Right: Output -->
        <div class="w-1/2 pl-5 flex flex-col space-y-2 overflow-auto">
          <h2 class="text-sm font-bold">Output</h2>
          <pre
            id="debug_output"
            class="flex-grow whitespace-pre-wrap break-all text-xs leading-snug border border-black p-2 rounded"
          ></pre>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script>
      /* ---------------- Panel toggle ---------------- */
      const panel = document.getElementById("debug-panel");
      document
        .getElementById("debug-toggle")
        .addEventListener("click", () =>
          panel.classList.toggle("translate-y-full"),
        );
      document
        .getElementById("debug-close")
        .addEventListener("click", () =>
          panel.classList.add("translate-y-full"),
        );

      /* --------------- Default DCQL ---------------- */
      const defaultQuery = `{
  "credentials": [
    {
      "id": "university_credential_presentation",
      "format": "ldp_vc",
      "meta": { "type_values": [["IDCredential"]] },
      "claims": [
        { "path": ["credentialSubject", "family_name"] },
        { "path": ["credentialSubject", "given_name"] },
        { "path": ["credentialSubject", "participation"] }
      ]
    }
  ]
}`;
      document.getElementById("dcql_query").value = defaultQuery;

      /* --------------- Helper vars --------------- */
      const qrImg = document.getElementById("qr_image");
      const walletBtn = document.getElementById("open_wallet");
      const statusBox = document.getElementById("verification-status");
      const statusText = document.getElementById("status-text");
      const dots = document.getElementById("dots");
      const errorBox = document.getElementById("error-box");
      const claimsBox = document.getElementById("claims-box");
      const claimsTable = document.getElementById("claims-table");

      /* ------- Populate claims table helper ------- */
      function populateClaimsTable(claims) {
        claimsTable.innerHTML = "";
        claims.forEach((c, i) => {
          const row = document.createElement("tr");
          row.className = i % 2 ? "bg-green-100" : "";
          row.innerHTML = `<td class='border px-2 py-1 whitespace-nowrap uppercase'>${c.name}</td><td class='border px-2 py-1 font-semibold'>${c.value}</td>`;
          claimsTable.appendChild(row);
        });
      }

      /* ---------- Backend polling functions -------- */
      let intervalId, timeoutId;
      async function checkTransaction(id) {
        try {
          const res = await fetch(`${location.origin}/${id}`);
          if (!res.ok) return; // keep polling
          const data = await res.json();
          // Build claim array and table
          const claims = data.map((r) => ({
            name: r.path.join("."),
            value: r.value,
          }));
          populateClaimsTable(claims);
          statusBox.classList.add("hidden");
          claimsBox.classList.remove("hidden");
          clearInterval(intervalId);
          clearTimeout(timeoutId);
          document.getElementById("debug_output").textContent = JSON.stringify(
            data,
            null,
            2,
          );
        } catch (err) {
          console.error(err);
        }
      }

      async function createQR() {
        document.getElementById("debug_output").textContent = "";
        const dcql_query = JSON.parse(
          document.getElementById("dcql_query").value,
        );
        const params = {
          response_mode: "direct_post",
          response_type: "vp_token",
          dcql_query,
          url: location.origin + "/verifier/",
        };
        try {
          const res = await fetch(
            `${location.origin}/verifier/generate_authorization_request`,
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(params),
            },
          );
          if (!res.ok) throw new Error(await res.text());
          const data = await res.json();
          qrImg.src = data.qr_code;
          walletBtn.href = data.intent_url;
          // Show status animation
          statusBox.classList.remove("hidden");
          let dotCnt = 0;
          const dotInterval = setInterval(() => {
            dotCnt = (dotCnt + 1) % 4;
            dots.textContent = ".".repeat(dotCnt);
          }, 400);
          // Poll backend
          intervalId = setInterval(
            () => checkTransaction(data.transaction_id),
            3000,
          );
          timeoutId = setTimeout(() => {
            clearInterval(intervalId);
            clearInterval(dotInterval);
            statusText.textContent = "Verification timed out";
            errorBox.textContent = "‚ùå Transaction timed out after 3 minutes.";
            errorBox.classList.remove("hidden");
          }, 180000);
        } catch (err) {
          errorBox.textContent = `Error: ${err.message}`;
          errorBox.classList.remove("hidden");
        }
      }

      /* Auto‚Äërun on load */
      window.addEventListener("load", createQR);
    </script>

    <!-- Typography: Gantari variable font -->
    <style>
      @font-face {
        font-family: "Gantari Variable";
        font-style: normal;
        font-display: swap;
        font-weight: 100 900;
        src: url(https://cdn.jsdelivr.net/fontsource/fonts/gantari:vf@latest/latin-wght-normal.woff2)
          format("woff2-variations");
        unicode-range:
          U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC,
          U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191,
          U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
      }
      body {
        font-family: "Gantari Variable", monospace;
      }
    </style>
  </body>
</html>
