steps:
  - id: Search for keyring and stop if found
    zencode: |
      Prepare 'result': execute in shell with command 'command_search_keyring'
      Given I have a 'string' named 'result'
      Then print the data
    keys:
      command_search_keyring: ./scripts/autorun_search.sh authz_server
    onError:
      zencodeFromFile: authz_server/.autorun/jwks.zen
      keysFromFile: authz_server/.autorun/jwks.keys.json
      data:
        result: "Keys found: "
      fail: false
  - id: Generates the keyring
    zencodeFromFile: authz_server/.autorun/generate_key.zen
    keys:
      controller: authorization_server
      command_store_keyring: ./scripts/autorun_store.sh authz_server
  - id: Generates the public keys
    zencodeFromFile: authz_server/.autorun/generate_public_key.zen
    dataFromStep: Generates the keyring
    keys:
      well-known_path: public/authz_server/.well-known/oauth-authorization-server
  - id: Generates the did
    zencodeFromFile: authz_server/.autorun/generate_did.zen
    dataFromStep: Generates the public keys
    keysFromFile: authz_server/.autorun/generate_did.keys.json
  - id: Save secrets in file
    zencodeFromFile: authz_server/.autorun/store_secrets.zen
    keysFromStep: Generates the keyring
    dataFromStep: Generates the did
  - id: Generates the jwks
    zencodeFromFile: authz_server/.autorun/jwks.zen
    keysFromFile: authz_server/.autorun/jwks.keys.json
    data:
      result: "Keys created: "
